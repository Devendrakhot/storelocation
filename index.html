
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Responsive Store Locator with Directions</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Maps JS API - Load only once -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDaS73atinqmmxe7tjz0pn3cUw2QbqJIA4"></script>
    <!-- MarkerClusterer library -->
    <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>

    <style>
        #map {
            width: 100%;
            height: 100%;
            border-radius: 1rem;
        }

        @media (max-width: 768px) {
            #map {
                height: 300px;
            }
        }

        /* Add loading indicator */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 1.2rem;
            color: #666;
        }

        /* Improve scroll performance */
        .store-list {
            transform: translateZ(0);
            will-change: transform;
        }
    </style>
</head>

<body class="h-screen bg-gray-100 font-sans p-[10px]">

    <div
        class="relative w-full h-full bg-white/20 backdrop-blur-md border border-gray-200 rounded-2xl flex flex-col md:flex-row overflow-hidden">

        <!-- MAP -->
        <div class="hidden md:flex-1 md:block relative h-full order-1 md:order-2">
            <div id="map" class="w-full h-full rounded-2xl">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin mr-2"></i> Loading map...
                </div>
            </div>
        </div>

        <!-- STORE PANEL -->
        <aside
            class="relative z-10 w-full md:w-96 bg-white/20 backdrop-blur-md border border-gray-200 rounded-2xl p-4 flex flex-col order-2 md:order-1 h-full">

            <!-- Search -->
            <div class="flex gap-2 mb-4">
                <button class="text-orange-400"><i class="fas fa-search"></i></button>
                <input id="searchInput" type="text" placeholder="Search by location, pincode, name..."
                    class="flex-1 bg-white/10 backdrop-blur-sm rounded-full px-3 py-2 border border-gray-200 focus:outline-none text-gray-900 placeholder-gray-600" />
                <button id="clearBtn" class="text-gray-400"><i class="fas fa-times"></i></button>
            </div>

            <!-- Store list -->
            <div id="storeList" class="store-list flex-1 overflow-y-auto space-y-4 md:overflow-y-auto">
                <!-- Cards injected via JS -->
            </div>
        </aside>
    </div>

    <script>
        (function () {
            const stores = [
            {
        "id": 1,
        "name ": "Chinmaya Tapovan Trust - Sidhbari",
        "state": "Himachal Pradesh",
        "pincode": 176057,
        "Tel.Number": "9899107730",
        "Email": "ctt@chinmayamission.com",
        "website": NaN,
        "lat": 32.17645359999999,
        "lng": 76.3594621
    },
    {
        "id": 2,
        "name ": "Chinmaya Mission - Bangalore",
        "state": "Karnataka",
        "pincode": 560038,
        "Tel.Number": "8025282207",
        "Email": "chinmaya.bgl@gmail.com",
        "website": NaN,
        "lat": 12.9628669,
        "lng": 77.57750899999999
    },
    {
        "id": 3,
        "name ": "Chinmaya Seva Centre - Singapore",
        "state": "Singapore",
        "pincode": 217667,
        "Tel.Number": "+65 9295 0303",
        "Email": "vsivathasan@gmail.com",
        "website": NaN,
        "lat": 1.3152369,
        "lng": 103.8563587
    },
    {
        "id": 4,
        "name ": "Chinmaya Mission - Thane",
        "state": "Maharashtra",
        "pincode": 400615,
        "Tel.Number": "2225970087",
        "Email": "chinmayapuja@yahoo.com",
        "website": NaN,
        "lat": 19.2628029,
        "lng": 72.9679207
    },
    {
        "id": 5,
        "name ": "Chinmaya Mission Edu. & Cultural Trust-Thrissur",
        "state": "Kerala",
        "pincode": 680020,
        "Tel.Number": 4872331452,
        "Email": "chinmayatrustthrissur@gmail.com",
        "website": NaN,
        "lat": 10.5241176,
        "lng": 76.2120649
    },
    {
        "id": 6,
        "name ": "Chinmaya Mission - Trichy",
        "state": "Tamil Nadu",
        "pincode": 620006,
        "Tel.Number": "4312433485",
        "Email": "cmtrichy2017@gmail.com",
        "website": NaN,
        "lat": 10.8499244,
        "lng": 78.6944176
    },
    {
        "id": 7,
        "name ": "Chinmaya Mission  West  Pub.- U.S.A.",
        "state": "Pennsylvania",
        "pincode": "19053-7210",
        "Tel.Number": "(215)396-0390",
        "Email": "siddhaji@gmail.com",
        "website": "https://www.chinmayapublications.com/",
        "lat": 39.999073,
        "lng": -123.7896347
    },
    {
        "id": 8,
        "name ": "Chinmaya Seva Trust - Mumbai",
        "state": "Maharashtra",
        "pincode": 400020,
        "Tel.Number": "02222884646",
        "Email": "enquiry@chinmayamissionmumbai.com",
        "website": NaN,
        "lat": 18.9581934,
        "lng": 72.8320729
    },
    {
        "id": 9,
        "name ": "Chinmaya Mission - U.K.",
        "state": "London",
        "pincode": "NW4 4BA",
        "Tel.Number": "2082036288",
        "Email": "info@chinmayauk.org",
        "website": "https://www.chinmayabooks.com/",
        "lat": 51.5878487,
        "lng": -0.2283831
    },
    {
        "id": 10,
        "name ": "Chinmaya Garden Trust - Coimbatore",
        "state": "Tamil Nadu",
        "pincode": 641022,
        "Tel.Number": "4222433315",
        "Email": "chinmayagarden@gmail.com",
        "website": NaN,
        "lat": 10.9300858,
        "lng": 76.7402347
    },
    {
        "id": 11,
        "name ": "C.M.E & C.Trust - Palakkad",
        "state": "Kerala",
        "pincode": 678001,
        "Tel.Number": "4912527366",
        "Email": "chinpgt@rediffmail.com",
        "website": NaN,
        "lat": 10.7733121,
        "lng": 76.6580401
    },
    {
        "id": 12,
        "name ": "Chinmaya Mission - Hyderabad",
        "state": "Telangana",
        "pincode": 500016,
        "Tel.Number": "4023410278",
        "Email": "chinmayamission.hyd@gmail.com",
        "website": NaN,
        "lat": 17.4361131,
        "lng": 78.46013330000001
    },
    {
        "id": 13,
        "name ": "hinmaya Mission Ahmedabad",
        "state": "Gujarat",
        "pincode": 380015,
        "Tel.Number": "079-26741527",
        "Email": "ahmedabad@chinmayamission.com",
        "website": NaN,
        "lat": 23.0280222,
        "lng": 72.52006639999999
    },
    {
        "id": 14,
        "name ": "Chinmaya Mission - Jaipur",
        "state": "Rajasthan",
        "pincode": 302019,
        "Tel.Number": "9024050095",
        "Email": "ashoksod2002@yahoo.com",
        "website": NaN,
        "lat": 26.896093,
        "lng": 75.7650323
    },
    {
        "id": 15,
        "name ": "Chinmaya Mission Australia - Chinmaya Prastha",
        "state": "Western Australia",
        "pincode": 6112,
        "Tel.Number": " +61414327330",
        "Email": "chinmayamissionperth@gmail.com",
        "website": "https://www.chinmaya.com.au/collections",
        "lat": -25.274398,
        "lng": 133.775136
    },
    {
        "id": 16,
        "name ": "Chinmaya Seva Trust - Belgaum",
        "state": "Karnataka",
        "pincode": 590006,
        "Tel.Number": "0831 2482853",
        "Email": "chinmayamissionbelgavi@gmail.com",
        "website": NaN,
        "lat": 15.8608974,
        "lng": 74.5129177
    },
    {
        "id": 17,
        "name ": "Chinmaya Mission - Nashik",
        "state": "Maharashtra",
        "pincode": 422003,
        "Tel.Number": "2517477",
        "Email": "ulhas.gaidhani@gmail.com",
        "website": NaN,
        "lat": 20.0109303,
        "lng": 73.7896628
    },
    {
        "id": 18,
        "name ": "Central Chinmaya Mission Trust - Kolkata Branch",
        "state": "West Bengal",
        "pincode": 700029,
        "Tel.Number": "33-24665069",
        "Email": "chinmayamission.kolkata@gmail.com",
        "website": NaN,
        "lat": 22.5743545,
        "lng": 88.3628734
    },
    {
        "id": 19,
        "name ": "Chinmaya Vidyalaya - Kannur",
        "state": "Kerala",
        "pincode": 670001,
        "Tel.Number": "497-2700876",
        "Email": "cvkannuroffice@gmail.com",
        "website": NaN,
        "lat": 11.8598724,
        "lng": 75.4263079
    },
    {
        "id": 20,
        "name ": "Chinmaya Mission - Sydney",
        "state": "New South Wales",
        "pincode": 2154,
        "Tel.Number": 61416482149,
        "Email": "sshrikarananda@chinmaya.com.au",
        "website": NaN,
        "lat": -33.728966,
        "lng": 150.985326
    },
    {
        "id": 21,
        "name ": "Chinmaya Mission - New Zealand",
        "state": "Auckland",
        "pincode": 2022,
        "Tel.Number": "02228034900",
        "Email": "nvnayak@hotmail.com",
        "website": "https://www.chinmaya.org.nz/product-category/children/",
        "lat": -36.9597945,
        "lng": 174.7873583
    },
    {
        "id": 22,
        "name ": "Chinmaya Krishna Trust - A/c.Hosur",
        "state": "Tamil Nadu",
        "pincode": 635110,
        "Tel.Number": "99449 46755",
        "Email": "chinmayaupasana108@gmail.com",
        "website": NaN,
        "lat": 12.7409127,
        "lng": 77.8252923
    },
    {
        "id": 23,
        "name ": "Chinmaya International Foundation - Ernakulam",
        "state": "Kerala",
        "pincode": "682 016",
        "Tel.Number": "4842376753",
        "Email": "cifpublications@chinfo.org",
        "website": NaN,
        "lat": 9.879132199999999,
        "lng": 76.45528929999999
    },
    {
        "id": 24,
        "name ": "Chinmaya Mission - Panchkula",
        "state": "Haryana",
        "pincode": 134116,
        "Tel.Number": "8968864799",
        "Email": "chinmayapanchkula@gmail.com",
        "website": NaN,
        "lat": 30.6648465,
        "lng": 76.8579365
    },
    {
        "id": 25,
        "name ": "Chinmaya Tapovan Trust - Ghaziabad",
        "state": "Uttar Pradesh",
        "pincode": 201002,
        "Tel.Number": "1202821909",
        "Email": "chinmayamissionghaziabad@gmail.com",
        "website": NaN,
        "lat": 28.6691565,
        "lng": 77.45375779999999
    },
    {
        "id": 26,
        "name ": "Chinmaya Vibhooti Project - Pune",
        "state": "Maharashtra",
        "pincode": 412108,
        "Tel.Number": "9689891959",
        "Email": "chinmaya.vani@chinmayamission.com",
        "website": NaN,
        "lat": 18.5246091,
        "lng": 73.8786239
    },
    {
        "id": 27,
        "name ": "Chinmaya Mission - Kadappa",
        "state": "Andhra Pradesh",
        "pincode": 516002,
        "Tel.Number": "9490033413",
        "Email": "chinmayamissionkadapa@gmail.com",
        "website": NaN,
        "lat": 14.4495259,
        "lng": 78.8809848
    },
    {
        "id": 28,
        "name ": "Chinmaya Pushpanjali - Kolhapur",
        "state": "Maharashtra",
        "pincode": 416008,
        "Tel.Number": "9146491960",
        "Email": "dattarajananda@chinmayamission.com",
        "website": NaN,
        "lat": 16.6886846,
        "lng": 74.2429618
    },
    {
        "id": 29,
        "name ": "Chinmaya Mission - A/c. Maauli - Pune",
        "state": "Maharashtra",
        "pincode": "411 047",
        "Tel.Number": "9975596394",
        "Email": NaN,
        "website": NaN,
        "lat": 18.5246091,
        "lng": 73.8786239
    },
    {
        "id": 30,
        "name ": "Chinmaya Mission - Gurugram",
        "state": "Haryana",
        "pincode": 122018,
        "Tel.Number": "8448725900",
        "Email": "reach.anitabhalla@gmail.com",
        "website": NaN,
        "lat": 28.4086377,
        "lng": 77.0583054
    },
    {
        "id": 31,
        "name ": "Chinmaya Seva Trust Kerala - Thrissur",
        "state": "Kerala",
        "pincode": 680020,
        "Tel.Number": "4872331466",
        "Email": "cstktcr@gmail.com",
        "website": NaN,
        "lat": 10.5282544,
        "lng": 76.2152752
    },
    {
        "id": 32,
        "name ": "Chinmaya Vidyalaya/ Mission - Kasargod",
        "state": "Kerala",
        "pincode": 671123,
        "Tel.Number": "4994255429",
        "Email": "chinmayakasargod@gmail.com",
        "website": NaN,
        "lat": 12.5206815,
        "lng": 75.0189467
    },
    {
        "id": 33,
        "name ": "Lucknow Chinmaya Seva Trust",
        "state": "Uttar Pradesh",
        "pincode": 226006,
        "Tel.Number": "9621566546",
        "Email": "lucknow@chinmayamission.com",
        "website": NaN,
        "lat": 26.8466937,
        "lng": 80.94616599999999
    },
    {
        "id": 34,
        "name ": "Chinmaya Mission - Chennai",
        "state": "Tamil Nadu",
        "pincode": 600031,
        "Tel.Number": "4428365046",
        "Email": "chinmayavani.chennai@gmail.com",
        "website": NaN,
        "lat": 13.0843007,
        "lng": 80.2704622
    },
    {
        "id": 35,
        "name ": "Chinmaya Seva Trust - Madurai",
        "state": "Tamil Nadu",
        "pincode": 625016,
        "Tel.Number": "4524394012",
        "Email": "chinmayamissionmadurai@gmail.com",
        "website": NaN,
        "lat": 9.9252007,
        "lng": 78.1197754
    },
    {
        "id": 36,
        "name ": "hinmaya Mission - Melbourne",
        "state": "Victoria",
        "pincode": 3106,
        "Tel.Number": "613 9846 8359",
        "Email": "gaskkr66@yahoo.com",
        "website": NaN,
        "lat": -37.7683204,
        "lng": 145.1473375
    },
    {
        "id": 37,
        "name ": "Chinmaya Mission - Mulund",
        "state": "Maharashtra",
        "pincode": 400080,
        "Tel.Number": "2225671381",
        "Email": "cmmulund@gmail.com",
        "website": NaN,
        "lat": 19.1685336,
        "lng": 72.9449953
    },
    {
        "id": 38,
        "name ": "Chinmaya Seva Trust - Nagpur",
        "state": "Maharashtra",
        "pincode": 440033,
        "Tel.Number": "7122544218",
        "Email": "cmnagpur@chinmayamission.com",
        "website": NaN,
        "lat": 21.1458004,
        "lng": 79.0881546
    },
    {
        "id": 39,
        "name ": "Chinmaya Mission - New Delhi",
        "state": "Delhi",
        "pincode": 110003,
        "Tel.Number": "1142908811",
        "Email": "books@chinmayamissiondelhi.org",
        "website": NaN,
        "lat": 28.5669432,
        "lng": 77.3414662
    }
            ];
            console.log(stores)
            const listEl = document.getElementById('storeList');
            const searchInput = document.getElementById('searchInput');
            const clearBtn = document.getElementById('clearBtn');

            let map;
            let markers = [];
            let markerCluster;
            let infoWindow;

            // Filter out stores with invalid coordinates
            // Filter out invalid or duplicate coordinates
            const seen = new Set();
            const validStores = stores.filter(store => {
                if (isNaN(store.lat) || isNaN(store.lng) || store.lat === null || store.lng === null) return false;
                const key = `${store.lat.toFixed(5)},${store.lng.toFixed(5)}`;
                if (seen.has(key)) return false; // Skip duplicate locations
                seen.add(key);
                return true;
            });


            function escapeHtml(str) {
                if (!str && str !== 0) return '';
                return String(str)
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            function initMap() {
                // Remove loading indicator
                const mapContainer = document.getElementById('map');
                const loadingEl = mapContainer.querySelector('.loading');
                if (loadingEl) {
                    loadingEl.remove();
                }

                map = new google.maps.Map(mapContainer, {
                    center: { lat: 20.5937, lng: 78.9629 },
                    zoom: 2.3,
                    gestureHandling: 'greedy', // Better touch handling
                    mapTypeControl: false, // Reduce UI elements for performance
                    streetViewControl: false
                });

                infoWindow = new google.maps.InfoWindow();

                // Create all markers at once for better performance
                createMarkers();
            }

            function createMarkers() {
                // Clear existing markers
                if (markerCluster) {
                    markerCluster.clearMarkers();
                }

                markers = [];
                const markerElements = [];

 // ðŸŸ  Use same orange circle SVG icon for single markers
validStores.forEach(store => {
  const color = "#f97316"; // Chinmaya orange

  // Make SVG for circular marker
  const svg = `
  <svg width="26" height="26" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z" fill="#f97316"></path>
            <circle cx="12" cy="9" r="2.2" fill="white"></circle>
          </svg>
  `;

  const svgIcon = {
    url: `data:image/svg+xml;base64,${btoa(svg)}`,
    scaledSize: new google.maps.Size(40, 40),
    anchor: new google.maps.Point(20, 40),
  };

  const marker = new google.maps.Marker({
    position: { lat: store.lat, lng: store.lng },
    title: store.name || store["name "] || store.Name || '',
    icon: svgIcon,
    optimized: true
  });


                    marker.addListener('click', () => {
                        // Check for website field (case-insensitive check)
                        const website = store.website || store.Website || store.url || store.URL || '';
                        const hasWebsite = website && String(website).trim() !== '';
                        const websiteBtnHtml = hasWebsite ? `
            <button id="webBtn" style="flex:1;background:#10B981;color:#fff;border:none;border-radius:4px;padding:4px 6px;font-size:12px;cursor:pointer;">
              <i class="fas fa-globe"></i> Website
            </button>` : '';
                        
                        // Check for comments
                        const comment = store.comment || store.Comment || store.comments || store.Comments || '';
                        const hasComment = comment && String(comment).trim() !== '' && String(comment).trim() !== 'NaN';
                        const commentHtml = hasComment ? `<div style="margin-top:6px; padding:6px; background:#f9fafb; border-left:3px solid #10B981; border-radius:4px; font-size:11px; color:#374151; line-height:1.4;">${escapeHtml(String(comment))}</div>` : '';
                        
                        const content = `
        <div style="min-width:200px;font-size:14px; padding:2px;">
          <strong style="font-size:15px; color:#1f2937;">${escapeHtml(store.name || store["name "] || store.Name || '')}</strong>
          ${hasComment ? commentHtml : ''}
          <div style="margin-top:10px; display:flex; gap:4px; flex-wrap:wrap;">
            <!-- <button id="callBtn" style="flex:1;background:#FBBF24;color:#fff;border:none;border-radius:4px;padding:6px 8px;font-size:12px;cursor:pointer;font-weight:500;">
              <i class="fas fa-phone"></i> Call
            </button> -->
            <button id="dirBtn" style="flex:1;background:#3B82F6;color:#fff;border:none;border-radius:4px;padding:6px 8px;font-size:12px;cursor:pointer;font-weight:500;">
              <i class="fas fa-directions"></i> Directions
            </button>
            ${websiteBtnHtml}
          </div>
        </div>
      `;
                        infoWindow.setContent(content);
                        infoWindow.open(map, marker);

                        setTimeout(() => {
                            // const callBtn = document.getElementById('callBtn');
                            const dirBtn = document.getElementById('dirBtn');
                            const webBtn = document.getElementById('webBtn');

                            // Call button functionality commented out
                            // if (callBtn) {
                            //     callBtn.addEventListener('click', () => {
                            //         // Get phone number from various possible field names
                            //         let tel = (store.phone || store.Phone || store['Tel.Number'] || store['tel.Number'] || '').toString().trim();
                            //         
                            //         // If missing, show alert
                            //         if (!tel || tel === 'NaN' || tel === 'undefined') {
                            //             alert(`Phone number not available for "${store.name}".`);
                            //             return;
                            //         }
                            //         
                            //         // Clean number - remove spaces, parentheses, dashes, and = sign
                            //         tel = tel.replace(/[\s()=-]/g, '');
                            //         
                            //         // Add +91 if missing (for Indian default)
                            //         if (!tel.startsWith('+')) {
                            //             if (tel.startsWith('0')) {
                            //                 tel = `+91${tel.slice(1)}`;
                            //             } else if (tel.length === 10) {
                            //                 tel = `+91${tel}`;
                            //             } else if (tel.length > 10 && !tel.startsWith('65') && !tel.startsWith('1')) {
                            //                 // For other countries, try to detect
                            //                 tel = `+${tel}`;
                            //             }
                            //         }
                            //         
                            //         // Open dialer
                            //         window.location.href = `tel:${tel}`;
                            //     });
                            // }

                            if (dirBtn) {
                                dirBtn.addEventListener('click', () => {
                                    const url = `https://www.google.com/maps/dir/?api=1&destination=${store.lat},${store.lng}`;
                                    window.open(url, '_blank');
                                });
                            }

                            if (webBtn && hasWebsite) {
                                webBtn.addEventListener('click', () => {
                                    let websiteUrl = String(website).trim();
                                    // Add https:// if no protocol is present
                                    if (!websiteUrl.match(/^https?:\/\//i)) {
                                        websiteUrl = 'https://' + websiteUrl;
                                    }
                                    window.open(websiteUrl, '_blank');
                                });
                            }
                        }, 100);
                    });

                    markers.push({ storeId: store.id, marker });
                    markerElements.push(marker);
                });

                // ðŸ§  Cluster logic (no clustering for single marker)
                markerCluster = new markerClusterer.MarkerClusterer({
                    map,
                    markers: markerElements,
                    renderer: {
                        render({ count, position, markers }) {
                            if (count === 1) {
                                return markers[0]; // show the actual marker
                            }

                            const color = "#f97316";
                            const svg = window.btoa(`
      <svg viewBox="0 0 40 40" width="40" height="40" xmlns="http://www.w3.org/2000/svg">
        <circle cx="20" cy="20" r="16" fill="${color}" opacity="0.9"/>
        <text x="50%" y="50%" dy=".35em" text-anchor="middle"
              fill="white" font-size="12" font-weight="bold">${count}</text>
      </svg>
    `);

                            return new google.maps.Marker({
                                position,
                                icon: {
                                    url: `data:image/svg+xml;base64,${svg}`,
                                    scaledSize: new google.maps.Size(40, 40), // reduced from 60x60
                                },
                                zIndex: google.maps.Marker.MAX_ZINDEX + count,
                            });
                        },
                    },

                });
            }

            function createCard(store) {
                // Check for website field (case-insensitive check)
                const website = store.website || store.Website || store.url || store.URL || '';
                const hasWebsite = website && String(website).trim() !== '';
                const websiteBtnHtml = hasWebsite ? `
        <button class="webBtn flex-1 flex items-center justify-center gap-2 py-2 bg-green-100 text-green-700 font-semibold rounded-lg hover:bg-green-200 transition-colors">
          <span><i class="fas fa-globe"></i></span>
          <span>Website</span>
        </button>` : '';
                
                const article = document.createElement('article');
                article.className = 'bg-white/25 backdrop-blur-md border border-gray-200 rounded-xl p-4 shadow-md transition-shadow duration-150 cursor-pointer';
                article.innerHTML = `
      <div class="flex gap-3 items-center">
        <div class="w-12 h-12 flex items-center justify-center bg-white/20 backdrop-blur-sm rounded-lg">
          <svg width="26" height="26" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z" fill="#F4A259"/>
            <circle cx="12" cy="9" r="2.2" fill="#fff"/>
          </svg>
        </div>
        <div class="flex-1">
          <h3 class="font-semibold text-gray-900 text-sm">${escapeHtml(store.name || store["name "] || store.Name || '')}</h3>
          <p class="text-gray-700 text-xs">${escapeHtml(store.short || '')}</p>
        </div>
      </div>

      <div class="mt-3 text-gray-800 text-xs space-y-1">
        <div class="flex gap-2"><span class="font-semibold w-20">Pincode:</span> <span>${escapeHtml(store.Pincode || store.pincode || '')}</span></div>
        <div class="flex gap-2"><span class="font-semibold w-20">State:</span> <span>${escapeHtml(store.State || store.state || '')}</span></div>
        <div class="flex gap-2"><span class="font-semibold w-20">Contact:</span> <span>${escapeHtml(store.phone || store.Phone || store['Tel.Number'] || store['tel.Number'] || '')}</span></div>
        <div class="flex gap-2"><span class="font-semibold w-20">Email:</span> <span>${escapeHtml(store.email || store.Email || '')}</span></div>
        ${(store.comment || store.Comment || store.comments || store.Comments) && String(store.comment || store.Comment || store.comments || store.Comments).trim() !== '' && String(store.comment || store.Comment || store.comments || store.Comments).trim() !== 'NaN' ? `<div class="mt-3 p-2 bg-green-50 border-l-4 border-green-400 rounded"><div class="flex gap-2"><span class="font-semibold w-20 text-green-800">Notes:</span></div><div class="text-gray-700 text-xs mt-1 italic">${escapeHtml(String(store.comment || store.Comment || store.comments || store.Comments))}</div></div>` : ''}
      </div>

      <div class="mt-3 flex gap-2 flex-wrap">
        <!-- Call button commented out -->
        <!-- <button class="callBtn flex-1 flex items-center justify-center gap-2 py-2 bg-orange-100 text-orange-700 font-semibold rounded-lg hover:bg-orange-200 transition-colors">
          <span><i class="fas fa-phone"></i></span>
          <span>Call Now</span>
        </button> -->
        <button class="dirBtn flex-1 flex items-center justify-center gap-2 py-2 bg-blue-100 text-blue-700 font-semibold rounded-lg hover:bg-blue-200 transition-colors">
          <span><i class="fas fa-directions"></i></span>
          <span>Directions</span>
        </button>
        ${websiteBtnHtml}
      </div>
    `;

                // const callBtn = article.querySelector('.callBtn');
                const dirBtn = article.querySelector('.dirBtn');
                const webBtn = article.querySelector('.webBtn');

                // Call button functionality commented out
                // callBtn.addEventListener('click', (e) => {
                //     e.stopPropagation();
                //
                //     // Get phone number from various possible field names
                //     let tel = (store.phone || store.Phone || store['Tel.Number'] || store['tel.Number'] || '').toString().trim();
                //
                //     // If missing, show alert
                //     if (!tel || tel === 'NaN' || tel === 'undefined') {
                //         alert(`Phone number not available for "${store.name}".`);
                //         return;
                //     }
                //
                //     // Clean number - remove spaces, parentheses, dashes, and = sign
                //     tel = tel.replace(/[\s()=-]/g, '');
                //
                //     // Add +91 if missing (for Indian default)
                //     if (!tel.startsWith('+')) {
                //         if (tel.startsWith('0')) {
                //             tel = `+91${tel.slice(1)}`;
                //         } else if (tel.length === 10) {
                //             tel = `+91${tel}`;
                //         } else if (tel.length > 10 && !tel.startsWith('65') && !tel.startsWith('1')) {
                //             // For other countries, try to detect
                //             tel = `+${tel}`;
                //         }
                //     }
                //
                //     // Open dialer
                //     window.location.href = `tel:${tel}`;
                // });

                dirBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const lat = store.lat;
                    const lng = store.lng;
                    const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
                    window.open(url, '_blank');
                });

                if (webBtn && hasWebsite) {
                    webBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        let websiteUrl = String(website).trim();
                        // Add https:// if no protocol is present
                        if (!websiteUrl.match(/^https?:\/\//i)) {
                            websiteUrl = 'https://' + websiteUrl;
                        }
                        window.open(websiteUrl, '_blank');
                    });
                }

                article.addEventListener('click', () => {
                    const markerObj = markers.find(m => m.storeId === store.id);
                    if (markerObj) {
                        map.panTo(markerObj.marker.getPosition());
                        map.setZoom(14);
                    }
                });

                return article;
            }

            function render(list) {
                listEl.innerHTML = '';
                if (!list || list.length === 0) {
                    listEl.innerHTML = '<div class="text-center text-gray-400 py-8"><i class="fas fa-store-slash text-4xl mb-4 opacity-50"></i><div>No stores found</div></div>';
                    return;
                }

                // Use document fragment for better performance
                const frag = document.createDocumentFragment();
                list.forEach(s => frag.appendChild(createCard(s)));
                listEl.appendChild(frag);
            }

            function filterStores(q) {
                const term = (q || '').toLowerCase().trim();
                if (!term) return validStores.slice();
                return validStores.filter(s => {
                    const name = (s.name || s["name "] || s.Name || '').toString().toLowerCase();
                    const short = (s.short || '').toString().toLowerCase();
                    const state = (s.State || s.state || '').toString().toLowerCase();
                    const pincode = (s.Pincode || s.pincode || '').toString();
                    const phone = (s.phone || s.Phone || s['Tel.Number'] || s['tel.Number'] || '').toString();
                    const email = (s.email || s.Email || '').toString().toLowerCase();
                    
                    return name.includes(term) ||
                           short.includes(term) ||
                           state.includes(term) ||
                           pincode.includes(term) ||
                           phone.includes(term) ||
                           email.includes(term);
                });
            }

            function debounce(fn, wait) {
                let t;
                return function (...args) {
                    clearTimeout(t);
                    t = setTimeout(() => fn.apply(this, args), wait);
                }
            }

            function init() {
                // Wait for Google Maps API to load
                if (typeof google === 'undefined') {
                    setTimeout(init, 100);
                    return;
                }

                initMap();
                render(validStores);
                const doFilter = debounce(() => render(filterStores(searchInput.value)), 400);

                searchInput.addEventListener('input', doFilter);
                clearBtn.addEventListener('click', () => {
                    searchInput.value = '';
                    render(validStores);
                    searchInput.focus();
                });
            }

            // Initialize when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
        })();
    </script>

</body>

</html>
